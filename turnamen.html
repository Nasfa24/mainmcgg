<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Chess Tournament LIVE</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-color: #1a1a2e; --card-bg: #16213e; --accent: #e94560; --text: #ffffff; --input-bg: #0f3460;
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: var(--bg-color); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* JUDUL TEGAS */
        h1 { 
            text-align: center; 
            color: var(--accent); 
            margin: 15px 0 20px 0;
            font-weight: 900; 
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 2px 2px 0px #000;
            font-size: 2em;
        }

        .center-box { text-align: center; }

        /* LOBBY STYLE */
        #lobby-section {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 999;
        }
        .lobby-card {
            background: var(--card-bg); padding: 30px; border-radius: 15px; border: 1px solid var(--accent);
            text-align: center; max-width: 400px; width: 90%;
        }
        .lobby-input {
            padding: 15px; font-size: 1.2em; text-align: center; text-transform: uppercase;
            border: 2px solid #555; border-radius: 8px; width: 80%; background: #0f172a; color: white; margin-bottom: 15px; letter-spacing: 2px;
        }

        /* APP STYLE */
        #app-wrapper { display: none; } /* Hidden until room selected */
        
        #setup-section { background: var(--card-bg); padding: 20px; border-radius: 10px; max-width: 500px; margin: 0 auto; display: none; }
        .input-group { margin-bottom: 10px; }
        input[type="text"], select { width: 100%; padding: 10px; background: var(--input-bg); border: 1px solid #333; color: white; border-radius: 5px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; }
        button:hover { background: #ff2e4c; }
        #app-section { display: none; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
        .game-panel, .leaderboard-panel { flex: 1; min-width: 300px; background: var(--card-bg); padding: 20px; border-radius: 10px; }
        .rank-row { display: flex; align-items: center; margin-bottom: 10px; background: var(--input-bg); padding: 8px; border-radius: 5px; }
        .rank-label { width: 80px; font-weight: bold; }
        .rank-points { width: 50px; text-align: right; margin-right: 10px; color: #aaa; font-size: 0.9em; }
        .tabs { display: flex; margin-bottom: 15px; }
        .tab-btn { flex: 1; background: #0f3460; margin-right: 5px; border-radius: 5px 5px 0 0; }
        .tab-btn.active { background: var(--accent); }
        .game-content { display: none; }
        .game-content.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #333; }
        th { background-color: var(--input-bg); }
        .rank-1 { color: #ffd700; font-weight: bold; }
        .rank-2 { color: #c0c0c0; font-weight: bold; }
        .rank-3 { color: #cd7f32; font-weight: bold; }
        .score-positive { color: #4cd137; }
        .score-negative { color: #e84118; }
        .score-neutral { color: #f5f6fa; }
        
        .status-bar { display: flex; justify-content: space-between; align-items: center; background: #000; padding: 5px 15px; border-radius: 5px; margin-bottom: 10px; font-size: 0.9em; }
        .live-indicator { color: #ef4444; font-weight: bold; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .admin-controls { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #333; }
        
        /* Disabled select */
        select:disabled { opacity: 1; color: #aaa; background: #0f3460; }
        option:disabled { font-style: italic; color: #555; background: #111; }

    </style>
</head>
<body>

<div id="lobby-section">
    <div class="lobby-card">
        <h2>üé™ PILIH ROOM</h2>
        <p style="color:#aaa; font-size:0.9em;">Masukkan Kode Unik untuk Turnamen ini.<br>Contoh: <b>MEJA1</b>, <b>FINAL</b>, <b>JKT</b></p>
        <input type="text" id="room-code-input" class="lobby-input" placeholder="KODE ROOM">
        <button onclick="enterRoom()">MASUK ROOM</button>
    </div>
</div>

<div id="app-wrapper" class="container">
    <div class="status-bar">
        <div>
            <span class="live-indicator">‚óè LIVE</span>
            <span style="color:#666; margin-left:10px;" id="display-room-id">ROOM: -</span>
        </div>
        <button id="btn-login" onclick="toggleAdmin()" style="width: auto; padding: 5px 15px; font-size: 0.8em; background: #333;">Admin Login</button>
    </div>

    <h1>üèÜ Magic Chess Tournament üèÜ</h1>
    <div class="center-box">
        <div id="share-link-box" style="font-size: 0.8em; color: #aaa; margin-bottom: 10px; cursor: pointer;" onclick="copyLink()">
            üìã Klik untuk copy link Share ke Penonton
        </div>
    </div>

    <div id="setup-section">
        <h2>Pendaftaran Pemain</h2>
        <div id="player-inputs"></div>
        <button onclick="saveSetupToFirebase()">SIMPAN & MULAI</button>
    </div>

    <div id="app-section">
        <div class="game-panel">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab(1)">Game 1</button>
                <button class="tab-btn" onclick="switchTab(2)">Game 2</button>
                <button class="tab-btn" onclick="switchTab(3)">Game 3</button>
            </div>
            <div id="game-forms">
                <p style="text-align:center; color:#888;">Memuat data...</p>
            </div>
        </div>

        <div class="leaderboard-panel">
            <h2>Klasemen Sementara</h2>
            <table>
                <thead><tr><th>Rank</th><th>Nama</th><th>G1</th><th>G2</th><th>G3</th><th>Total</th></tr></thead>
                <tbody id="leaderboard-body"></tbody>
            </table>
            
            <div class="admin-controls" id="admin-panel">
                <p style="color: #aaa; font-size: 0.8em; text-align: center;">Menu Admin</p>
                <button onclick="showSetup()" style="background-color: #555; margin-bottom: 5px;">Edit Nama Pemain</button>
                <button onclick="resetTournament()" style="background-color: #aa2222;">Hapus Data Room Ini</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- KONFIGURASI FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyDLiGNB82sYfYVEd4OHx1eAXScaLrA5-Ps",
        authDomain: "mcgg-turney.firebaseapp.com",
        databaseURL: "https://mcgg-turney-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "mcgg-turney",
        storageBucket: "mcgg-turney.firebasestorage.app",
        messagingSenderId: "475861111074",
        appId: "1:475861111074:web:3c637d7ee44ecd71a9157b",
        measurementId: "G-PMDETSSGYS"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const POINT_SYSTEM = [7, 5, 3, 1, 0, -2, -4, -6];
    let players = [];
    let isAdmin = false;
    let gameResults = { 1: {}, 2: {}, 3: {} };
    let CURRENT_ROOM = null;

    // --- SYSTEM LOBBY / ROOM ---
    
    // Cek apakah ada kode di URL (contoh: mainmcgg.id/turnamen.html?code=MEJA1)
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        if(code) {
            document.getElementById('room-code-input').value = code;
            enterRoom();
        }
    };

    function enterRoom() {
        const inputCode = document.getElementById('room-code-input').value.toUpperCase().trim().replace(/[^A-Z0-9]/g, '');
        
        if(!inputCode) { alert("Masukkan Kode Room dulu!"); return; }
        
        CURRENT_ROOM = inputCode;
        document.getElementById('lobby-section').style.display = 'none';
        document.getElementById('app-wrapper').style.display = 'block';
        document.getElementById('display-room-id').innerText = `ROOM: ${CURRENT_ROOM}`;
        
        // Update URL di browser tanpa reload (agar kalau dicopy sudah ada kodenya)
        const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?code=' + CURRENT_ROOM;
        window.history.pushState({path:newUrl},'',newUrl);

        initApp();
    }

    function copyLink() {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => alert("Link tersalin! Kirim ke penonton/peserta."));
    }

    // --- LOGIKA UTAMA ---

    function initApp() {
        // Generate Input Setup
        const playerInputsContainer = document.getElementById('player-inputs');
        playerInputsContainer.innerHTML = '';
        for (let i = 1; i <= 8; i++) {
            playerInputsContainer.innerHTML += `<div class="input-group"><input type="text" id="p${i}" placeholder="Nama Pemain ${i}"></div>`;
        }

        // CONNECT KE DATABASE SPESIFIK ROOM (tournaments/NAMAROOM)
        db.ref('tournaments/' + CURRENT_ROOM).on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                players = data.players || [];
                gameResults = data.results || { 1: {}, 2: {}, 3: {} };
                
                if (players.length > 0) {
                    document.getElementById('setup-section').style.display = 'none';
                    document.getElementById('app-section').style.display = 'flex';
                    generateGameForms(); 
                    updateLeaderboardUI();
                }
            } else {
                // Room baru / kosong
                if (isAdmin) {
                    document.getElementById('setup-section').style.display = 'block';
                    document.getElementById('app-section').style.display = 'none';
                } else {
                    document.getElementById('game-forms').innerHTML = '<p style="text-align:center; margin-top:50px;">‚è≥ Menunggu Admin Setup Room...</p>';
                }
            }
        });
    }

    // --- UI GENERATOR ---
    function generateGameForms() {
        const container = document.getElementById('game-forms');
        const scrollPos = container.scrollTop;
        
        let activeTab = 1;
        document.querySelectorAll('.game-content').forEach((el, idx) => { if(el.classList.contains('active')) activeTab = idx + 1; });

        container.innerHTML = '';

        for (let gameId = 1; gameId <= 3; gameId++) {
            let isActive = (gameId === activeTab) ? 'active' : '';
            let html = `<div id="game-${gameId}" class="game-content ${isActive}">`;
            html += `<h3>Input Hasil Game ${gameId}</h3>`;
            
            for (let rank = 1; rank <= 8; rank++) {
                let points = POINT_SYSTEM[rank-1];
                let pointClass = points > 0 ? 'score-positive' : (points < 0 ? 'score-negative' : 'score-neutral');
                let pointDisplay = points > 0 ? `+${points}` : points;
                let selectedPlayer = (gameResults[gameId] && gameResults[gameId][rank]) ? gameResults[gameId][rank] : "";

                html += `
                <div class="rank-row">
                    <div class="rank-label">Rank ${rank}</div>
                    <div class="rank-points ${pointClass}">${pointDisplay} Pts</div>
                    <select id="g${gameId}-r${rank}" onchange="handleSelection(${gameId}, ${rank}, this.value)" ${isAdmin ? '' : 'disabled'}>
                        <option value="">-- ${isAdmin ? 'Pilih' : '-'} --</option>
                        ${players.map(p => `<option value="${p}" ${p === selectedPlayer ? 'selected' : ''}>${p}</option>`).join('')}
                    </select>
                </div>`;
            }
            html += `</div>`;
            container.innerHTML += html;
            if(isAdmin) refreshDropdownOptions(gameId);
        }
        container.scrollTop = scrollPos;
    }

    function refreshDropdownOptions(gameId) {
        let selectedInThisGame = [];
        for (let r = 1; r <= 8; r++) {
            let el = document.getElementById(`g${gameId}-r${r}`);
            if (el && el.value) selectedInThisGame.push(el.value);
        }
        for (let r = 1; r <= 8; r++) {
            let el = document.getElementById(`g${gameId}-r${r}`);
            if (!el) continue;
            let myValue = el.value;
            let options = el.querySelectorAll('option');
            options.forEach(opt => {
                if (opt.value === "") return;
                if (selectedInThisGame.includes(opt.value) && opt.value !== myValue) {
                    opt.disabled = true; opt.innerText = `‚ùå ${opt.value}`;
                } else {
                    opt.disabled = false; opt.innerText = opt.value;
                }
            });
        }
    }

    // --- ACTIONS ---
    function handleSelection(gameId, rank, playerName) {
        if (!isAdmin) return;
        refreshDropdownOptions(gameId);
        // Simpan ke Room spesifik
        db.ref(`tournaments/${CURRENT_ROOM}/results/${gameId}/${rank}`).set(playerName);
    }

    function switchTab(gameId) {
        document.querySelectorAll('.tab-btn').forEach((btn, index) => btn.classList.toggle('active', index + 1 === gameId));
        document.querySelectorAll('.game-content').forEach(content => content.classList.remove('active'));
        const activeContent = document.getElementById(`game-${gameId}`);
        if(activeContent) activeContent.classList.add('active');
    }

    function updateLeaderboardUI() {
        let leaderboard = players.map(p => ({ name: p, g1: 0, g2: 0, g3: 0, total: 0 }));

        for (let g = 1; g <= 3; g++) {
            if (gameResults[g]) {
                for (let rank = 1; rank <= 8; rank++) {
                    let playerName = gameResults[g][rank];
                    if (playerName) {
                        let points = POINT_SYSTEM[rank-1];
                        let pData = leaderboard.find(p => p.name === playerName);
                        if (pData) {
                            if (g === 1) pData.g1 = points;
                            if (g === 2) pData.g2 = points;
                            if (g === 3) pData.g3 = points;
                            pData.total += points;
                        }
                    }
                }
            }
        }
        leaderboard.sort((a, b) => b.total - a.total);
        const tbody = document.getElementById('leaderboard-body');
        tbody.innerHTML = '';

        leaderboard.forEach((p, index) => {
            let rankClass = index === 0 ? 'rank-1' : (index === 1 ? 'rank-2' : (index === 2 ? 'rank-3' : ''));
            tbody.innerHTML += `<tr><td class="${rankClass}">#${index + 1}</td><td class="${rankClass}">${p.name}</td><td>${p.g1}</td><td>${p.g2}</td><td>${p.g3}</td><td style="font-weight:bold; font-size:1.1em;">${p.total}</td></tr>`;
        });
    }

    function saveSetupToFirebase() {
        let newPlayers = [];
        for (let i = 1; i <= 8; i++) {
            let name = document.getElementById(`p${i}`).value.trim();
            if(!name) name = `Player ${i}`;
            newPlayers.push(name);
        }
        if(confirm(`Mulai turnamen di Room ${CURRENT_ROOM}?`)) {
            db.ref(`tournaments/${CURRENT_ROOM}`).set({
                players: newPlayers,
                results: { 1: {}, 2: {}, 3: {} }
            });
        }
    }

    function resetTournament() {
        if(confirm(`‚ö†Ô∏è Hapus data Room ${CURRENT_ROOM}? Data tidak bisa kembali.`)) {
            db.ref(`tournaments/${CURRENT_ROOM}`).remove();
            location.reload();
        }
    }
    
    function showSetup() {
        document.getElementById('setup-section').style.display = 'block';
        document.getElementById('app-section').style.display = 'none';
        players.forEach((p, i) => { if(document.getElementById(`p${i+1}`)) document.getElementById(`p${i+1}`).value = p; });
    }

    function toggleAdmin() {
        const pass = prompt("Password Admin:");
        if(pass === "admin123") {
            isAdmin = true;
            document.getElementById('btn-login').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            let selects = document.querySelectorAll('select');
            selects.forEach(s => s.disabled = false);
            if(players.length === 0) document.getElementById('setup-section').style.display = 'block';
            generateGameForms();
            alert("Admin Mode: ON");
        } else {
            alert("Salah Password");
        }
    }
</script>

</body>
</html>